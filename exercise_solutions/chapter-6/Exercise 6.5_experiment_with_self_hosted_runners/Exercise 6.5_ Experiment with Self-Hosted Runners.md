### **Exercise 6.5: Experiment with Self-Hosted Runners**

Let‚Äôs do a simple experiment with private runners using our pipeline tool, CircleCI.

Start a local instance of Kubernetes on your laptop and use the container-agent service provided by CircleCI to create a private runner resource that will watch for Circleci projects configured to use it and run the pipelines on containers started within the local cluster. 

For this exercise, we will need the following tools: CircleCI cli[^1], Kind[^2], Kubectl[^3], Helm[^4]. These can be installed on MacOS using the homebrew package manager as follows. See the tool documentation for installation on other operating systems.

$ brew install kind kubectl helm circleci

### **Solutions to Exercise 6.5: Experiment with Self-Hosted Runners**

Follow the instructions to authenticate using the CircleCI cli.

If you haven‚Äôt already, you will need to define an organizational namespace for your circleci account.

$ circleci namespace create \<name\> \--org-id \<your-organization-id\>

The \<your-organization-id\> is the GitHub organization name that you integrated with CircleCI. Circle recommends that you use the same name for the namespace, but you are free to use any unique name. An organization may only have a single namespace. The same namespace is used for both your organization‚Äôs orbs as well as private runner resource classes.

For epetech, assuming our github organization is also epetech then we could create the resource namespace as:  

$ circleci namespace create epetech \--org-id epetech

Next, create a resource class to identify your self-hosted runner namespace with the following command.

$ circleci runner resource-class create epetech/experiment ‚Äòprivate runner experiment‚Äô \--generate-token

api:  
    auth\_token: f776a3e34\*\*\*\*\*\*\*\*\*\*  
\+------------------------+---------------------------+  
|  RESOURCE CLASS        |        DESCRIPTION        |  
\+------------------------+---------------------------+  
| epetech/experiment  | private runner experiment |  
\+------------------------+---------------------------+

Store the auth\_token in our secrets manager.

Now, let‚Äôs run a local instance of Kubernetes using Kind and create a Kubernetes namespace for this exercise.

$ kind create cluster \--name experiment

Creating cluster "experiment" ‚Ä¶  
 ‚úì Ensuring node image (kindest/node:v1.29.2) üñº  
 ‚úì Preparing nodes üì¶  
 ‚úì Writing configuration üìú  
 ‚úì Starting control-plane üïπÔ∏è  
 ‚úì Installing CNI üîå  
 ‚úì Installing StorageClass üíæ

Set kubectl context to "kind-experiment"  
You can now use your cluster with:

kubectl cluster-info \--context kind-experiment

Create a circleci namespace.

$ kubectl create namespace circleci

Add the circleci helm repository using the following commands.

$ helm repo add container-agent https://packagecloud.io/circleci/container-agent/helm  
$ helm repo update

Create a values.yaml for this helm deployment with the following contents.

Agent:  
  resourceClasses:  
    epetech/experiment:  
      token: f776a3e34\*\*\*\*\*\*\*\*\*\*

Use the \<namespace\> you previously created and the token generated by creating the runner resource class above.

Deploy the runner agent using the following command.

$ helm install container-agent container-agent/container-agent \-n circleci \-f values.yaml

If everything worked, you should see something like the following on your Self-Hosted Runners tab in CircleCI.

![][image1]

Finally, create a git repo and add the following simple pipeline to test our private runner. Use the \<namespace\> and \<resource-class\> you defined above.

\# .circleci/config.yml

version: 2.1

jobs:  
  build:  
    docker:  
      \- image: cimg/base:current  
    resource\_class: epetech/experiment  
    steps:  
      \- checkout  
      \- run: echo "Hi I'm on Runners\!"

workflows:  
  build-workflow:  
    jobs:  
      \- build

Connect this repo from the Projects tab in CircleCI and start the pipeline building. You will see the executor initialize and run on your local cluster, followed by the example pipeline project using the runner to perform the pipeline tasks. The CircleCI project window will look something like this:

![][image2]

See the CircleCI documentation[^5] for additional information. If you are attempting the exercises in the rest of this book without access to a cloud vendor, it is possible to use a private runner on a local Kind cluster to test many of the kubernetes service and extension deployments.

[^1]:  https://circleci.com/docs/local-cli/

[^2]:  https://kind.sigs.k8s.io/docs/user/quick-start/\#installation

[^3]:  https://kubernetes.io/docs/tasks/tools/

[^4]:  https://helm.sh/docs/intro/install/

[^5]:  https://circleci.com/docs/container-runner-installation/
